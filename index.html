<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Luau Obfuscator Terminal</title>
<style>
  body, html {
    margin:0; padding:0; height:100%;
    background: #0f0f0f;
    color: #d0d0d0;
    font-family: "Courier New", Courier, monospace;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #terminal {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #111;
    white-space: pre-wrap;
    user-select: text;
  }
  #input-line {
    display: flex;
    padding: 0.5rem 1rem;
    background: #222;
    border-top: 1px solid #333;
  }
  #input-prompt {
    color: #6fdb6f;
    margin-right: 0.5rem;
    user-select: none;
  }
  #command-input {
    flex: 1;
    background: transparent;
    border: none;
    color: #d0d0d0;
    font-family: monospace;
    font-size: 1rem;
    outline: none;
  }
  #command-input::placeholder {
    color: #555;
  }
  #fileInput {
    display: none;
  }
  .output-error {
    color: #f66;
  }
  .output-info {
    color: #6fdb6f;
  }
  .output-command {
    color: #4f9f4f;
  }
  .output-code {
    color: #ccc;
    background: #222;
    padding: 0.5rem;
    margin: 0.5rem 0;
    white-space: pre-wrap;
    border-radius: 4px;
  }
</style>
</head>
<body>

<div id="terminal"></div>

<div id="input-line">
  <div id="input-prompt">user@luau-obfuscator:$</div>
  <input id="command-input" autocomplete="off" autofocus placeholder="Type 'help' for commands" />
</div>

<input type="file" id="fileInput" accept=".lua,.txt" />

<script>
  const terminal = document.getElementById('terminal');
  const cmdInput = document.getElementById('command-input');
  const fileInput = document.getElementById('fileInput');

  let codeContent = '';
  let varMap = null;

  function printLine(text, cssClass = '') {
    const div = document.createElement('div');
    if(cssClass) div.classList.add(cssClass);
    div.textContent = text;
    terminal.appendChild(div);
    terminal.scrollTop = terminal.scrollHeight;
  }

  function printCodeBlock(text) {
    const div = document.createElement('pre');
    div.classList.add('output-code');
    div.textContent = text;
    terminal.appendChild(div);
    terminal.scrollTop = terminal.scrollHeight;
  }

  function randomName(len = 6) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let str = '';
    for(let i=0; i<len; i++) {
      str += chars.charAt(Math.floor(Math.random()*chars.length));
    }
    return str;
  }

  function findVariables(code) {
    const varRegex = /local\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;
    let vars = new Set();
    let match;
    while((match = varRegex.exec(code)) !== null) {
      vars.add(match[1]);
    }
    return Array.from(vars);
  }

  function obfuscateCode(code) {
    code = code.replace(/--\[\[[\s\S]*?\]\]/gm, '');
    code = code.replace(/--.*$/gm, '');
    if(varMap === null) {
      varMap = {};
      const vars = findVariables(code);
      vars.forEach(v => {
        varMap[v] = randomName();
      });
    }
    Object.keys(varMap).forEach(orig => {
      const re = new RegExp('\\b' + orig + '\\b', 'g');
      code = code.replace(re, varMap[orig]);
    });
    code = code
      .replace(/\n+/g, ' ')
      .replace(/\s{2,}/g, ' ')
      .replace(/\s*([=+*\/\-\(\),])\s*/g, '$1')
      .trim();
    return code;
  }

  function saveFile(filename, content) {
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'code.lua';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function formatCode(code) {
    let formatted = code.replace(/;/g,';\n').replace(/{/g,'{\n').replace(/}/g,'}\n');
    formatted = formatted.replace(/\n\s*\n/g,'\n');
    return formatted.trim();
  }

  function showStats(code) {
    const lines = code.split('\n').length;
    const chars = code.length;
    const words = code.match(/\b\w+\b/g)?.length || 0;
    const vars = findVariables(code).length;
    return `Lines: ${lines} | Chars: ${chars} | Words: ${words} | Local vars: ${vars}`;
  }

  function handleCommand(cmdLine) {
    const parts = cmdLine.trim().split(' ');
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1);
    switch(cmd) {
      case 'help':
        printLine('Available commands:', 'output-info');
        printLine('help           - Show this help');
        printLine('upload         - Select and upload a .lua or .txt file');
        printLine('obfuscate      - Obfuscate and minify the current code');
        printLine('show           - Show current loaded code');
        printLine('clear          - Clear current loaded code');
        printLine('exit           - Clear terminal output');
        printLine('save <file>    - Save current code as file');
        printLine('lines          - Show number of lines');
        printLine('vars           - List local variables');
        printLine('reset          - Reset variable mappings');
        printLine('uppercase      - Convert code to uppercase');
        printLine('lowercase      - Convert code to lowercase');
        printLine('reverse        - Reverse entire code text');
        printLine('count <word>   - Count occurrences of a word');
        printLine('clear-output   - Clear only terminal output');
        printLine('format         - Simple code formatting');
        printLine('stats          - Show code statistics');
        printLine('replace <from> <to> - Replace all occurrences');
        printLine('version        - Show tool version');
        printLine('time           - Show current time');
        break;

      case 'upload':
        fileInput.click();
        break;

      case 'obfuscate':
        if(!codeContent) {
          printLine('No code loaded. Use "upload" or paste code.', 'output-error');
          break;
        }
        printLine('Obfuscating...', 'output-info');
        setTimeout(() => {
          try {
            codeContent = obfuscateCode(codeContent);
            printCodeBlock(codeContent);
          } catch(e) {
            printLine('Obfuscation error: ' + e.message, 'output-error');
          }
        }, 100);
        break;

      case 'show':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        printLine('Current code:', 'output-info');
        printCodeBlock(codeContent);
        break;

      case 'clear':
        codeContent = '';
        varMap = null;
        printLine('Code cleared.', 'output-info');
        break;

      case 'exit':
        terminal.innerHTML = '';
        break;

      case 'save':
        if(!codeContent) {
          printLine('No code to save.', 'output-error');
          break;
        }
        const fname = args[0] || 'code.lua';
        saveFile(fname, codeContent);
        printLine(`Code saved as "${fname}"`, 'output-info');
        break;

      case 'lines':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        printLine('Lines: ' + codeContent.split('\n').length, 'output-info');
        break;

      case 'vars':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        const vars = findVariables(codeContent);
        if(vars.length) {
          printLine('Local variables: ' + vars.join(', '), 'output-info');
        } else {
          printLine('No local variables found.', 'output-info');
        }
        break;

      case 'reset':
        varMap = null;
        printLine('Variable mappings reset.', 'output-info');
        break;

      case 'uppercase':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        codeContent = codeContent.toUpperCase();
        printLine('Code converted to uppercase.', 'output-info');
        break;

      case 'lowercase':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        codeContent = codeContent.toLowerCase();
        printLine('Code converted to lowercase.', 'output-info');
        break;

      case 'reverse':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        codeContent = codeContent.split('').reverse().join('');
        printLine('Code reversed.', 'output-info');
        break;

      case 'count':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        if(args.length === 0) {
          printLine('Specify a word to count.', 'output-error');
          break;
        }
        const word = args[0];
        const re = new RegExp('\\b' + word + '\\b', 'g');
        const count = (codeContent.match(re) || []).length;
        printLine(`Occurrences of "${word}": ${count}`, 'output-info');
        break;

      case 'clear-output':
        terminal.innerHTML = '';
        break;

      case 'format':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        codeContent = formatCode(codeContent);
        printLine('Code formatted.', 'output-info');
        break;

      case 'stats':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        printLine(showStats(codeContent), 'output-info');
        break;

      case 'replace':
        if(!codeContent) {
          printLine('No code loaded.', 'output-error');
          break;
        }
        if(args.length < 2) {
          printLine('Usage: replace <from> <to>', 'output-error');
          break;
        }
        const from = args[0];
        const to = args.slice(1).join(' ');
        const reReplace = new RegExp(from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        codeContent = codeContent.replace(reReplace, to);
        printLine(`Replaced all "${from}" with "${to}"`, 'output-info');
        break;

      case 'version':
        printLine('Luau Obfuscator Terminal v1.0', 'output-info');
        break;

      case 'time':
        printLine('Current time: ' + new Date().toLocaleString(), 'output-info');
        break;

      default:
        printLine('Unknown command: ' + cmd + '. Type "help" for list.', 'output-error');
    }
  }

  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) {
      printLine('No file selected.', 'output-error');
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      codeContent = reader.result;
      varMap = null;
      printLine(`Loaded file: ${file.name}`, 'output-info');
    };
    reader.readAsText(file);
  });

  printLine('Welcome to Luau Obfuscator Terminal!');
  printLine('Type "help" for a list of commands.', 'output-info');

  cmdInput.addEventListener('keydown', e => {
    if(e.key === 'Enter') {
      const input = cmdInput.value.trim();
      if(!input) return;
      printLine('user@luau-obfuscator:$ ' + input, 'output-command');
      cmdInput.value = '';
      handleCommand(input);
    }
  });
</script>

</body>
</html>
